
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>torequests.crawlers &#8212; torequests 4.6.5 documentation</title>
    <link rel="stylesheet" href="../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">torequests 4.6.5 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for torequests.crawlers</h1><div class="highlight"><pre>
<span></span><span class="ch">#! coding:utf-8</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>

<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="k">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">wraps</span>

<span class="kn">from</span> <span class="nn">.logs</span> <span class="k">import</span> <span class="n">print_info</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="k">import</span> <span class="p">(</span><span class="n">Counts</span><span class="p">,</span> <span class="n">ensure_dict_key_title</span><span class="p">,</span> <span class="n">ensure_request</span><span class="p">,</span> <span class="n">md5</span><span class="p">,</span>
                    <span class="n">parse_qsl</span><span class="p">,</span> <span class="n">slice_by_size</span><span class="p">,</span> <span class="n">timepass</span><span class="p">,</span> <span class="n">ttime</span><span class="p">,</span> <span class="n">unparse_qsl</span><span class="p">,</span>
                    <span class="n">urlparse</span><span class="p">,</span> <span class="n">urlunparse</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">.versions</span> <span class="k">import</span> <span class="n">PY2</span><span class="p">,</span> <span class="n">PY3</span><span class="p">,</span> <span class="n">PY35_PLUS</span>

<span class="k">if</span> <span class="n">PY3</span><span class="p">:</span>
    <span class="n">unicode</span> <span class="o">=</span> <span class="nb">str</span>
    <span class="kn">from</span> <span class="nn">http.cookies</span> <span class="k">import</span> <span class="n">SimpleCookie</span>
    <span class="kn">from</span> <span class="nn">json.decoder</span> <span class="k">import</span> <span class="n">JSONDecodeError</span>

<span class="k">if</span> <span class="n">PY2</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">Cookie</span> <span class="k">import</span> <span class="n">SimpleCookie</span>
    <span class="n">JSONDecodeError</span> <span class="o">=</span> <span class="ne">ValueError</span>

<span class="k">if</span> <span class="n">PY35_PLUS</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.dummy</span> <span class="k">import</span> <span class="n">Requests</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.main</span> <span class="k">import</span> <span class="n">tPool</span> <span class="k">as</span> <span class="n">Requests</span>


<div class="viewcode-block" id="CommonRequests"><a class="viewcode-back" href="../../torequests.html#torequests.crawlers.CommonRequests">[docs]</a><span class="k">class</span> <span class="nc">CommonRequests</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">request</span><span class="p">,</span>
                 <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                 <span class="n">interval</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">ensure_response</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">retry</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                 <span class="n">logger_function</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">encoding</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1">#: If not set, will use print_info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger_function</span> <span class="o">=</span> <span class="n">logger_function</span> <span class="ow">or</span> <span class="n">print_info</span>
        <span class="c1">#: torequests&#39;s async requests tool.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">req</span> <span class="o">=</span> <span class="n">Requests</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1">#: default encoding or detected by response</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="n">encoding</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">ensure_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;headers&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="p">:</span>
            <span class="n">request</span><span class="p">[</span><span class="s1">&#39;headers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ensure_dict_key_title</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="s1">&#39;headers&#39;</span><span class="p">])</span>
        <span class="c1">#: request: dict or curl-string or url; </span>
        <span class="c1">#: self.request should not be modified</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">request</span>
        <span class="c1">#: max reties for bad response.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">retry</span> <span class="o">=</span> <span class="n">retry</span>
        <span class="c1">#: default timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
        <span class="c1">#: function to check the same response.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensure_response</span> <span class="o">=</span> <span class="n">ensure_response</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_response</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_original_response</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_ensure_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">):</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">x</span>
        <span class="k">if</span> <span class="n">r</span><span class="p">:</span>
            <span class="c1"># r.content is not need to be encode.</span>
            <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">md5</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">skip_encode</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                              <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">r</span>

<div class="viewcode-block" id="CommonRequests.init_original_response"><a class="viewcode-back" href="../../torequests.html#torequests.crawlers.CommonRequests.init_original_response">[docs]</a>    <span class="k">def</span> <span class="nf">init_original_response</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the original response for comparing, confirm ``is_cookie_necessary``&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;json&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;json&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
        <span class="n">r1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">req</span><span class="o">.</span><span class="n">request</span><span class="p">(</span>
            <span class="n">retry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">retry</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">)</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">r1</span><span class="o">.</span><span class="n">x</span>
        <span class="k">assert</span> <span class="n">resp</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s1">&#39;original_response should not be failed. </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="ow">or</span> <span class="n">resp</span><span class="o">.</span><span class="n">encoding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">original_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_response</span><span class="p">(</span><span class="n">r1</span><span class="p">)</span></div>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_response</span>

<div class="viewcode-block" id="CommonRequests.check_response_unchanged"><a class="viewcode-back" href="../../torequests.html#torequests.crawlers.CommonRequests.check_response_unchanged">[docs]</a>    <span class="k">def</span> <span class="nf">check_response_unchanged</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resp</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">):</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">x</span></div></div>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_response</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_response</span>


<div class="viewcode-block" id="CleanRequest"><a class="viewcode-back" href="../../torequests.html#torequests.crawlers.CleanRequest">[docs]</a><span class="k">class</span> <span class="nc">CleanRequest</span><span class="p">(</span><span class="n">CommonRequests</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Clean the non-sense request args but return the original response.</span>

<span class="sd">    Basic Usage::</span>

<span class="sd">        &gt;&gt;&gt; from torequests.crawlers import CleanRequest</span>
<span class="sd">        &gt;&gt;&gt; request = &#39;&#39;&#39;curl &#39;https://p.3.cn?skuIds=1&amp;nonsense=1&amp;nonce=0&#39; -H &#39;Pragma: no-cache&#39; -H &#39;DNT: 1&#39; -H &#39;Accept-Encoding: gzip, deflate&#39; -H &#39;Accept-Language: zh-CN,zh;q=0.9&#39; -H &#39;Upgrade-Insecure-Requests: 1&#39; -H &#39;User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/63.0.3239.84 Safari/537.36&#39; -H &#39;Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8&#39; -H &#39;Cache-Control: no-cache&#39; -H &#39;Referer: https://p.3.cn?skuIds=1&amp;nonsense=1&amp;nonce=0&#39; -H &#39;Cookie: ASPSESSIONIDSQRRSADB=MLHDPOPCAMBDGPFGBEEJKLAF&#39; -H &#39;Connection: keep-alive&#39; --compressed&#39;&#39;&#39;</span>
<span class="sd">        &gt;&gt;&gt; c = CleanRequest(request)</span>
<span class="sd">        &gt;&gt;&gt; c.x</span>
<span class="sd">        {&#39;url&#39;: &#39;https://p.3.cn&#39;, &#39;method&#39;: &#39;get&#39;}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">request</span><span class="p">,</span>
                 <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                 <span class="n">interval</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">ensure_response</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">retry</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                 <span class="n">logger_function</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;request: dict or curl-string or url.</span>
<span class="sd">        Cookie need to be set in headers.&quot;&quot;&quot;</span>
        <span class="c1">#: request args which can be ignored.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignore</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;qsl&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;Cookie&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;headers&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;json_data&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;form_data&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;total_data&#39;</span><span class="p">:</span> <span class="p">[]</span>
        <span class="p">}</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CleanRequest</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">,</span>
            <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span>
            <span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">,</span>
            <span class="n">ensure_response</span><span class="o">=</span><span class="n">ensure_response</span><span class="p">,</span>
            <span class="n">retry</span><span class="o">=</span><span class="n">retry</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
            <span class="n">logger_function</span><span class="o">=</span><span class="n">logger_function</span><span class="p">,</span>
            <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1">#: The list of async-requests task.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1">#: If the post-data should be seen as json.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_json_data</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1">#: The cleaned request to be return at last.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_request</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">)</span>

<div class="viewcode-block" id="CleanRequest.init_original_response"><a class="viewcode-back" href="../../torequests.html#torequests.crawlers.CleanRequest.init_original_response">[docs]</a>    <span class="k">def</span> <span class="nf">init_original_response</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the original response for comparing, confirm is_cookie_necessary&quot;&quot;&quot;</span>
        <span class="n">no_cookie_resp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_cookie_necessary</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="s1">&#39;json&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;json&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
        <span class="n">r1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">req</span><span class="o">.</span><span class="n">request</span><span class="p">(</span>
            <span class="n">retry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">retry</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;headers&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">:</span>
            <span class="c1"># test is_cookie_necessary</span>
            <span class="n">cookie</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">[</span><span class="s1">&#39;headers&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Cookie&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cookie</span><span class="p">:</span>
                <span class="n">r2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">req</span><span class="o">.</span><span class="n">request</span><span class="p">(</span>
                    <span class="n">retry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">retry</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">)</span>
                <span class="n">no_cookie_resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_response</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">r1</span><span class="o">.</span><span class="n">x</span>
        <span class="k">assert</span> <span class="n">resp</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s1">&#39;original_response should not be failed. </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">original_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensure_response</span><span class="p">(</span><span class="n">r1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="ow">or</span> <span class="n">resp</span><span class="o">.</span><span class="n">encoding</span>
        <span class="k">if</span> <span class="n">no_cookie_resp</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_response</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ignore</span><span class="p">[</span><span class="s1">&#39;headers&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Cookie&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_cookie_necessary</span> <span class="o">=</span> <span class="kc">False</span></div>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_response</span>

<div class="viewcode-block" id="CleanRequest.sort_url_qsl"><a class="viewcode-back" href="../../torequests.html#torequests.crawlers.CleanRequest.sort_url_qsl">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">sort_url_qsl</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">raw_url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Do nothing but sort the params of url.</span>

<span class="sd">            raw_url: the raw url to be sorted; </span>
<span class="sd">            kwargs: (optional) same kwargs for ``sorted``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parsed_url</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">raw_url</span><span class="p">)</span>
        <span class="n">qsl</span> <span class="o">=</span> <span class="n">parse_qsl</span><span class="p">(</span><span class="n">parsed_url</span><span class="o">.</span><span class="n">query</span><span class="p">)</span></div>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_join_url</span><span class="p">(</span><span class="n">parsed_url</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">qsl</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_add_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">task</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">req</span><span class="o">.</span><span class="n">request</span><span class="p">(</span>
                <span class="n">retry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">retry</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span>
                <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">check_response_unchanged</span><span class="p">,</span>
                <span class="o">**</span><span class="n">request</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_join_url</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">parsed_url</span><span class="p">,</span> <span class="n">new_qsl</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">urlunparse</span><span class="p">((</span><span class="n">parsed_url</span><span class="o">.</span><span class="n">scheme</span><span class="p">,</span> <span class="n">parsed_url</span><span class="o">.</span><span class="n">netloc</span><span class="p">,</span>
                           <span class="n">parsed_url</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">parsed_url</span><span class="o">.</span><span class="n">params</span><span class="p">,</span>
                           <span class="n">unparse_qsl</span><span class="p">(</span><span class="n">new_qsl</span><span class="p">),</span> <span class="n">parsed_url</span><span class="o">.</span><span class="n">fragment</span><span class="p">))</span>

<div class="viewcode-block" id="CleanRequest.clean_url"><a class="viewcode-back" href="../../torequests.html#torequests.crawlers.CleanRequest.clean_url">[docs]</a>    <span class="k">def</span> <span class="nf">clean_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Only clean the url params and return self.&quot;&quot;&quot;</span>
        <span class="n">raw_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span>
        <span class="n">parsed_url</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">raw_url</span><span class="p">)</span>
        <span class="n">qsl</span> <span class="o">=</span> <span class="n">parse_qsl</span><span class="p">(</span><span class="n">parsed_url</span><span class="o">.</span><span class="n">query</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">qs</span> <span class="ow">in</span> <span class="n">qsl</span><span class="p">:</span>
            <span class="n">new_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_url</span><span class="p">(</span><span class="n">parsed_url</span><span class="p">,</span>
                                     <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">qsl</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">qs</span><span class="p">])</span>
            <span class="n">new_request</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">)</span>
            <span class="n">new_request</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_url</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_task</span><span class="p">(</span><span class="s1">&#39;qsl&#39;</span><span class="p">,</span> <span class="n">qs</span><span class="p">,</span> <span class="n">new_request</span><span class="p">)</span></div>
        <span class="k">return</span> <span class="bp">self</span>

<div class="viewcode-block" id="CleanRequest.clean_post_data"><a class="viewcode-back" href="../../torequests.html#torequests.crawlers.CleanRequest.clean_post_data">[docs]</a>    <span class="k">def</span> <span class="nf">clean_post_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Only clean the post-data and return self. </span>
<span class="sd">        </span>
<span class="sd">        Including form-data / bytes-data / json-data.&quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">data</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;post&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="c1"># case of total_data</span>
        <span class="n">new_request</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">)</span>
        <span class="n">new_request</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_task</span><span class="p">(</span><span class="s1">&#39;total_data&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">new_request</span><span class="p">)</span>

        <span class="c1"># case of form_data</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">new_request</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">)</span>
                <span class="n">new_form</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">new_form</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">new_request</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_form</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_task</span><span class="p">(</span><span class="s1">&#39;form_data&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">new_request</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="c1"># case of json_data</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">json_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">json_data</span><span class="p">:</span>
                <span class="n">new_request</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">)</span>
                <span class="n">new_json</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">json_data</span><span class="p">)</span>
                <span class="n">new_json</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">new_request</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">new_json</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_task</span><span class="p">(</span><span class="s1">&#39;json_data&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">new_request</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">has_json_data</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">except</span> <span class="n">JSONDecodeError</span><span class="p">:</span></div>
            <span class="k">return</span> <span class="bp">self</span>

<div class="viewcode-block" id="CleanRequest.clean_cookie"><a class="viewcode-back" href="../../torequests.html#torequests.crawlers.CleanRequest.clean_cookie">[docs]</a>    <span class="k">def</span> <span class="nf">clean_cookie</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Only clean the cookie from headers and return self.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_cookie_necessary</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;headers&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">cookies</span> <span class="o">=</span> <span class="n">SimpleCookie</span><span class="p">(</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Cookie&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cookies</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">new_cookie</span> <span class="o">=</span> <span class="s1">&#39;; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">OutputString</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cookies</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">v</span><span class="p">])</span>
            <span class="n">new_request</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">)</span>
            <span class="n">new_request</span><span class="p">[</span><span class="s1">&#39;headers&#39;</span><span class="p">][</span><span class="s1">&#39;Cookie&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_cookie</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_task</span><span class="p">(</span><span class="s1">&#39;Cookie&#39;</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">new_request</span><span class="p">)</span></div>
        <span class="k">return</span> <span class="bp">self</span>

<div class="viewcode-block" id="CleanRequest.clean_headers"><a class="viewcode-back" href="../../torequests.html#torequests.crawlers.CleanRequest.clean_headers">[docs]</a>    <span class="k">def</span> <span class="nf">clean_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Only clean the headers (cookie include) and return self.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;headers&#39;</span><span class="p">),</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">[</span><span class="s1">&#39;headers&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;Cookie&#39;</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clean_cookie</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
            <span class="c1"># cookie will be checked in other methods.</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;Cookie&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">new_request</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">)</span>
            <span class="n">new_headers</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span>
            <span class="n">new_headers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">new_request</span><span class="p">[</span><span class="s1">&#39;headers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_headers</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_task</span><span class="p">(</span><span class="s1">&#39;headers&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">new_request</span><span class="p">)</span></div>
        <span class="k">return</span> <span class="bp">self</span>

<div class="viewcode-block" id="CleanRequest.reset_new_request"><a class="viewcode-back" href="../../torequests.html#torequests.crawlers.CleanRequest.reset_new_request">[docs]</a>    <span class="k">def</span> <span class="nf">reset_new_request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove the non-sense args from the self.ignore, return self.new_request&quot;&quot;&quot;</span>
        <span class="n">raw_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_request</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span>
        <span class="n">parsed_url</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">raw_url</span><span class="p">)</span>
        <span class="n">qsl</span> <span class="o">=</span> <span class="n">parse_qsl</span><span class="p">(</span><span class="n">parsed_url</span><span class="o">.</span><span class="n">query</span><span class="p">)</span>
        <span class="n">new_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_url</span><span class="p">(</span>
            <span class="n">parsed_url</span><span class="p">,</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">qsl</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore</span><span class="p">[</span><span class="s1">&#39;qsl&#39;</span><span class="p">]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_request</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger_function</span><span class="p">(</span><span class="s1">&#39;ignore: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore</span><span class="p">[</span><span class="s1">&#39;headers&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">new_request</span><span class="p">[</span><span class="s1">&#39;headers&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;headers&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">new_request</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;headers&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore</span><span class="p">[</span><span class="s1">&#39;Cookie&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;Cookie&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore</span><span class="p">[</span><span class="s1">&#39;headers&#39;</span><span class="p">]:</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_request</span><span class="p">[</span><span class="s1">&#39;headers&#39;</span><span class="p">]</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span> <span class="n">headers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">}</span>
            <span class="k">if</span> <span class="s1">&#39;Cookie&#39;</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
                <span class="n">cookies</span> <span class="o">=</span> <span class="n">SimpleCookie</span><span class="p">(</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Cookie&#39;</span><span class="p">])</span>
                <span class="n">new_cookie</span> <span class="o">=</span> <span class="s1">&#39;; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                    <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">OutputString</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cookies</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore</span><span class="p">[</span><span class="s1">&#39;Cookie&#39;</span><span class="p">]</span>
                <span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">new_request</span><span class="p">[</span><span class="s1">&#39;headers&#39;</span><span class="p">][</span><span class="s1">&#39;Cookie&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_cookie</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_request</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;post&#39;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_request</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore</span><span class="p">[</span><span class="s1">&#39;form_data&#39;</span><span class="p">]:</span>
                        <span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">data</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore</span><span class="p">[</span><span class="s1">&#39;total_data&#39;</span><span class="p">]:</span>
                    <span class="c1"># not need data any more</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">new_request</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_json_data</span> <span class="ow">and</span> <span class="s1">&#39;data&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_request</span><span class="p">:</span>
                    <span class="n">json_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore</span><span class="p">[</span><span class="s1">&#39;json_data&#39;</span><span class="p">]:</span>
                        <span class="n">json_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">new_request</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">json_data</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span></div>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_request</span>

<div class="viewcode-block" id="CleanRequest.clean_all"><a class="viewcode-back" href="../../torequests.html#torequests.crawlers.CleanRequest.clean_all">[docs]</a>    <span class="k">def</span> <span class="nf">clean_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clean the url + post-data + headers, return self.&quot;&quot;&quot;</span></div>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_url</span><span class="p">()</span><span class="o">.</span><span class="n">clean_post_data</span><span class="p">()</span><span class="o">.</span><span class="n">clean_headers</span><span class="p">()</span>

<div class="viewcode-block" id="CleanRequest.result"><a class="viewcode-back" href="../../torequests.html#torequests.crawlers.CleanRequest.result">[docs]</a>    <span class="k">def</span> <span class="nf">result</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Whole task, clean_all + reset_new_request, return self.new_request.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clean_all</span><span class="p">()</span>
        <span class="n">tasks_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger_function</span><span class="p">(</span>
            <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> tasks of request, will cost at least </span><span class="si">%s</span><span class="s1"> seconds.&#39;</span> <span class="o">%</span>
            <span class="p">(</span><span class="n">tasks_length</span><span class="p">,</span>
             <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">req</span><span class="o">.</span><span class="n">interval</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">req</span><span class="o">.</span><span class="n">n</span> <span class="o">*</span> <span class="n">tasks_length</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">req</span><span class="o">.</span><span class="n">x</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
            <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">fut</span> <span class="o">=</span> <span class="n">task</span>
            <span class="k">if</span> <span class="n">fut</span><span class="o">.</span><span class="n">x</span> <span class="ow">and</span> <span class="n">fut</span><span class="o">.</span><span class="n">cx</span><span class="p">:</span>
                <span class="c1"># fut.x == req success &amp; fut.cx == response not changed.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ignore</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_new_request</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">x</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Property as self.result()&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>


<div class="viewcode-block" id="Seed"><a class="viewcode-back" href="../../torequests.html#torequests.crawlers.Seed">[docs]</a><span class="k">class</span> <span class="nc">Seed</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;frequency&#39;</span><span class="p">,</span> <span class="s1">&#39;request&#39;</span><span class="p">,</span> <span class="s1">&#39;item_parsers&#39;</span><span class="p">,</span> <span class="s1">&#39;encoding&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">item_parsers</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;item_parsers: {&#39;item_name1&#39;: parser_chain1, &#39;item_name2&#39;: parser_chain2}&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">frequency</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">))</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item_parsers</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">item_parsers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">unicode</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">frequency</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">ensure_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_parsers</span> <span class="o">=</span> <span class="n">item_parsers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="n">encoding</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">as_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Property return the value for keys of __slots__.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__slots__</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">as_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Property return key-value dict from __slots__.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__slots__</span><span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">as_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Property return key-value json-string from __slots__.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">as_dict</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="n">ensure_ascii</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
        <span class="k">return</span> <span class="s1">&#39;Seed(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_json</span>


<div class="viewcode-block" id="StressTest"><a class="viewcode-back" href="../../torequests.html#torequests.crawlers.StressTest">[docs]</a><span class="k">class</span> <span class="nc">StressTest</span><span class="p">(</span><span class="n">CommonRequests</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;StressTest for a request(dict/curl-string/url).</span>

<span class="sd">    Basic Usage::</span>

<span class="sd">        &gt;&gt;&gt; from torequests.crawlers import StressTest</span>
<span class="sd">        &gt;&gt;&gt; StressTest(&#39;http://p.3.cn&#39;).x</span>
<span class="sd">        [2018-03-13 00:33:52]: [154] response: f3f97a64-612, start at 2018-03-13 00:33:51 (+00:00:00), 165.0 req/s [100.00 %]</span>
<span class="sd">        [2018-03-13 00:33:52]: [155] response: f3f97a64-612, start at 2018-03-13 00:33:51 (+00:00:00), 166.0 req/s [100.00 %]</span>
<span class="sd">        [2018-03-13 00:33:52]: [156] response: f3f97a64-612, start at 2018-03-13 00:33:51 (+00:00:00), 167.0 req/s [100.00 %]</span>
<span class="sd">        [2018-03-13 00:33:52]: [157] response: f3f97a64-612, start at 2018-03-13 00:33:51 (+00:00:00), 167.0 req/s [100.00 %]</span>
<span class="sd">        [2018-03-13 00:33:52]: [158] response: f3f97a64-612, start at 2018-03-13 00:33:51 (+00:00:00), 168.0 req/s [100.00 %]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">request</span><span class="p">,</span>
                 <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                 <span class="n">interval</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">ensure_response</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">retry</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                 <span class="n">logger_function</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">encoding</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">total_tries</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">total_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">shutdown</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">shutdown_changed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">chunk_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;request: dict or curl-string or url.</span>
<span class="sd">        Cookie need to be set in headers.&quot;&quot;&quot;</span>
        <span class="n">logger_function</span> <span class="o">=</span> <span class="n">logger_function</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logger_function</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">StressTest</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">,</span>
            <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span>
            <span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">,</span>
            <span class="n">ensure_response</span><span class="o">=</span><span class="n">ensure_response</span><span class="p">,</span>
            <span class="n">retry</span><span class="o">=</span><span class="n">retry</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
            <span class="n">logger_function</span><span class="o">=</span><span class="n">logger_function</span><span class="p">,</span>
            <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1">#: counter for all response fetched</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="n">Counts</span><span class="p">()</span>
        <span class="c1">#: counter for success response fetched</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">succ_counter</span> <span class="o">=</span> <span class="n">Counts</span><span class="p">()</span>
        <span class="c1">#: timestamp for starting up, time.time()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="c1">#: readable-time-string for starting up, ttime(self.start_time)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_time_readable</span> <span class="o">=</span> <span class="n">ttime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span>
        <span class="c1">#: the limit of total response count, stop the script while reaching.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_tries</span> <span class="o">=</span> <span class="n">total_tries</span> <span class="ow">or</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
        <span class="c1">#: the limit of time run-time, stop the script while reaching.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_time</span> <span class="o">=</span> <span class="n">total_time</span> <span class="ow">or</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
        <span class="c1">#: shutdown function, ``os._exit(0)`` if not set.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shutdown</span> <span class="o">=</span> <span class="n">shutdown</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown</span>
        <span class="c1">#: shutdown if response changed.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shutdown_changed</span> <span class="o">=</span> <span class="n">shutdown_changed</span>
        <span class="c1">#: fetch requests chunk_size each time, default 100</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chunk_size</span> <span class="o">=</span> <span class="n">chunk_size</span>
        <span class="c1">#: StressTest callback function, will be wrapped.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">st_callback</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">st_callback_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ensure_response</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">_exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">speed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Speed property, the unit can be `req / s`. </span>

<span class="sd">        Returns: the num of request is fetched in one second.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter</span><span class="o">.</span><span class="n">now</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">passed</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">succ_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The request rate of success. Returns :string like `100.00%`&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1"> </span><span class="si">%%</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">succ_counter</span><span class="o">.</span><span class="n">now</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">passed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This attribute returns the seconds after starting up.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span>

    <span class="k">def</span> <span class="nf">_logger_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="n">log_str</span> <span class="o">=</span> <span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">] response: </span><span class="si">%s</span><span class="s1">, start at </span><span class="si">%s</span><span class="s1"> (+</span><span class="si">%s</span><span class="s1">), </span><span class="si">%s</span><span class="s1"> req/s [</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">counter</span><span class="o">.</span><span class="n">now</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time_readable</span><span class="p">,</span>
            <span class="n">timepass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">passed</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">speed</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">succ_rate</span><span class="p">)</span>
        <span class="n">print_info</span><span class="p">(</span><span class="n">log_str</span><span class="p">)</span>

<div class="viewcode-block" id="StressTest.st_callback_wrapper"><a class="viewcode-back" href="../../torequests.html#torequests.crawlers.StressTest.st_callback_wrapper">[docs]</a>    <span class="k">def</span> <span class="nf">st_callback_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;add shutdown checker for origin callback function.&quot;&quot;&quot;</span>

        <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
            <span class="c1"># if tries end or timeout or shutdown_changed =&gt; shutdown</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">counter</span><span class="o">.</span><span class="n">x</span>
            <span class="n">succ</span> <span class="o">=</span> <span class="n">result</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_response</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter</span><span class="o">.</span><span class="n">now</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_tries</span><span class="p">:</span>
                <span class="n">print_info</span><span class="p">(</span><span class="s1">&#39;shutdown for: total_tries: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_time</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">passed</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_time</span><span class="p">:</span>
                <span class="n">print_info</span><span class="p">(</span><span class="s1">&#39;shutdown for: total_time: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_time</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">succ</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">succ_counter</span><span class="o">.</span><span class="n">x</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">shutdown_changed</span><span class="p">:</span>
                <span class="n">print_info</span><span class="p">(</span><span class="s1">&#39;shutdown for: shutdown_changed: </span><span class="si">%s</span><span class="s1"> =&gt; </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                           <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">original_response</span><span class="p">,</span> <span class="n">result</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger_function</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>
</div>
        <span class="k">return</span> <span class="n">wrapper</span>

<div class="viewcode-block" id="StressTest.start"><a class="viewcode-back" href="../../torequests.html#torequests.crawlers.StressTest.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Start the task cycle.&quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">req</span><span class="o">.</span><span class="n">request</span><span class="p">(</span>
                    <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">st_callback</span><span class="p">,</span>
                    <span class="n">retry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">retry</span><span class="p">,</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span>
                    <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chunk_size</span><span class="p">)</span>
            <span class="p">]</span></div>
            <span class="bp">self</span><span class="o">.</span><span class="n">req</span><span class="o">.</span><span class="n">x</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">x</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This attribute returns self.start()&quot;&quot;&quot;</span></div>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">torequests 4.6.5 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, Clericpy.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.1.
    </div>
  </body>
</html>